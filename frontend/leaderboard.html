<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Battle Boats - Leaderboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .lb-card {
            background: #34495e;
            border-radius: 14px;
            padding: 22px;
            width: min(920px, calc(100% - 32px));
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            overflow: hidden;
            border-radius: 10px;
        }

        th, td {
            padding: 12px 10px;
            border-bottom: 1px solid rgba(236,240,241,0.12);
            text-align: left;
        }

        th {
            background: #2c3e50;
            color: #f1c40f;
            font-weight: 800;
        }

        tr:nth-child(even) td { background: rgba(0,0,0,0.08); }

        .rank {
            width: 60px;
            font-weight: 900;
        }

        .muted { color: #bdc3c7; }
        #error { color: #e74c3c; font-weight: bold; margin-top: 12px; }
    </style>
</head>
<body class="centered-layout">

<div class="lb-card">
    <button onclick="window.location.href='menu.html'" class="btn-back">‚¨Ö √énapoi la Meniu</button>
    <h1 style="text-align:center; margin: 12px 0 4px 0;">üèÜ Leaderboard</h1>
    <p class="muted" style="text-align:center; margin: 0;">Sortat dupƒÉ wins, win rate, meciuri jucate</p>

    <div id="error"></div>

    <table>
        <thead>
        <tr>
            <th class="rank">#</th>
            <th>Username</th>
            <th>Wins</th>
            <th>Losses</th>
            <th>Games</th>
            <th>Win rate</th>
        </tr>
        </thead>
        <tbody id="rows">
        <tr><td colspan="6" class="muted">Se √ÆncarcƒÉ...</td></tr>
        </tbody>
    </table>
</div>

<script src="config.js"></script>
<script type="module">
    import { db } from './firebase.js';
    import { collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';

    const connectedUser = localStorage.getItem('connectedUser');
    if (!connectedUser) {
        window.location.href = 'index.html';
    }

    const CACHE_KEY = 'bb_cache_leaderboard_v1';

    function safeNum(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n : 0;
    }

    function render(list) {
        const rowsEl = document.getElementById('rows');
        rowsEl.innerHTML = '';

        (list || []).forEach((e, idx) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="rank">${idx + 1}</td>
                <td>${e.username}</td>
                <td>${e.wins}</td>
                <td>${e.losses}</td>
                <td>${e.gamesPlayed}</td>
                <td>${Number(e.winRate).toFixed(1)}%</td>
            `;
            rowsEl.appendChild(tr);
        });

        if (!list || list.length === 0) {
            rowsEl.innerHTML = `<tr><td colspan="6" class="muted">Nu existƒÉ conturi √ÆncƒÉ.</td></tr>`;
        }
    }

    function loadCached() {
        try {
            const raw = localStorage.getItem(CACHE_KEY);
            if (!raw) return null;
            const obj = JSON.parse(raw);
            if (!Array.isArray(obj)) return null;
            return obj;
        } catch {
            return null;
        }
    }

    function saveCached(list) {
        try {
            localStorage.setItem(CACHE_KEY, JSON.stringify(list || []));
        } catch {
            // ignore
        }
    }

    async function loadLeaderboard() {
        // 1) Instant render from cache
        const cached = loadCached();
        if (cached) {
            render(cached);
        } else {
            document.getElementById('rows').innerHTML = `<tr><td colspan="6" class="muted">Se √ÆncarcƒÉ...</td></tr>`;
        }

        try {
            const usersSnap = await getDocs(collection(db, 'users'));
            const byUid = new Map();
            usersSnap.forEach(d => {
                const u = d.data() || {};
                byUid.set(d.id, {
                    uid: d.id,
                    username: u.username || 'Anon',
                    wins: 0,
                    losses: 0,
                });
            });

            const lbSnap = await getDocs(query(collection(db, 'leaderboard'), orderBy('wins', 'desc'), limit(500)));
            lbSnap.forEach(d => {
                const data = d.data() || {};
                const entry = byUid.get(d.id) || { uid: d.id, username: data.username || 'Anon', wins: 0, losses: 0 };
                entry.username = entry.username || data.username || 'Anon';
                entry.wins = safeNum(data.wins);
                entry.losses = safeNum(data.losses);
                byUid.set(d.id, entry);
            });

            const list = Array.from(byUid.values()).map(e => {
                const gamesPlayed = e.wins + e.losses;
                const winRate = gamesPlayed ? (e.wins * 100 / gamesPlayed) : 0;
                return { ...e, gamesPlayed, winRate };
            });

            list.sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                if (b.winRate !== a.winRate) return b.winRate - a.winRate;
                if (b.gamesPlayed !== a.gamesPlayed) return b.gamesPlayed - a.gamesPlayed;
                return String(a.username).localeCompare(String(b.username));
            });

            saveCached(list);
            render(list);
        } catch (e) {
            console.error(e);
            document.getElementById('error').innerText = `‚ùå Nu pot √ÆncƒÉrca leaderboard: ${e.message}`;
        }
    }

    loadLeaderboard();
</script>

</body>
</html>
