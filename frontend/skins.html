<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Personalizare Skin-uri</title>
    <link rel="stylesheet" href="style.css">
    <!-- Stilurile pentru pagina de skins sunt acum in style.css -->
</head>
<body class="centered-layout">
    <div class="skins-container">
        <button onclick="window.location.href='menu.html'" class="btn-back">â¬… ÃŽnapoi la Meniu</button>

        <h1>ðŸŽ¨ Personalizare Skin-uri Nave</h1>
        <p style="color: #bdc3c7;">Alege skin-urile pentru fiecare tip de navÄƒ</p>

        <div id="skins-content">
            <p>Se Ã®ncarcÄƒ...</p>
        </div>

        <div id="save-status" style="margin-top:12px; min-height:22px; font-weight:700;"></div>

        <button onclick="saveSkins()" class="btn-save">ðŸ’¾ SalveazÄƒ Skin-urile</button>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE_URL = window.API_BASE_URL;
        let userId = null;
        let currentSkins = {};

        // AUTH GUARD
        const connectedUser = localStorage.getItem("connectedUser");
        if (!connectedUser) {
            window.location.href = "index.html";
        }

        // Skin-uri disponibile pentru fiecare tip (folosim fiÈ™iere existente din /img)
        const availableSkins = {
            1: [
                { path: "img/default.png", name: "Default" },
                { path: "img/2.png", name: "Skin 2" },
                { path: "img/3.png", name: "Skin 3" },
                { path: "img/4.png", name: "Skin 4" }
            ],
            2: [
                { path: "img/default.png", name: "Default" },
                { path: "img/2.png", name: "Skin 2" },
                { path: "img/3.png", name: "Skin 3" },
                { path: "img/4.png", name: "Skin 4" }
            ],
            3: [
                { path: "img/default.png", name: "Default" },
                { path: "img/2.png", name: "Skin 2" },
                { path: "img/3.png", name: "Skin 3" },
                { path: "img/4.png", name: "Skin 4" }
            ],
            4: [
                { path: "img/default.png", name: "Default" },
                { path: "img/2.png", name: "Skin 2" },
                { path: "img/3.png", name: "Skin 3" },
                { path: "img/4.png", name: "Skin 4" }
            ]
        };

        const shipTypeNames = {
            1: "BÄƒrci (1 bloc)",
            2: "DistrugÄƒtoare (2 blocuri)",
            3: "CruciÈ™Äƒtoare (3 blocuri)",
            4: "Portavion (4 blocuri)"
        };

        window.onload = async function() {
            const username = localStorage.getItem("connectedUser");
            console.log("=== INCARCARE SKINS.HTML ===");
            console.log("Username din localStorage:", username);

            if (!username) {
                alert("Nu eÈ™ti autentificat!");
                window.location.href = "index.html";
                return;
            }

            try {
                // ObÈ›inem userId
                console.log("Fetch user data pentru:", username);
                const userResponse = await fetch(`${API_BASE_URL}/api/auth/user/${username}`);
                console.log("User response status:", userResponse.status);

                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    console.log("User data:", userData);
                    userId = userData.id;

                    // ObÈ›inem skin-urile curente
                    console.log("Fetch skins pentru userId:", userId);
                    const skinsResponse = await fetch(`${API_BASE_URL}/api/skins/${userId}`);
                    console.log("Skins response status:", skinsResponse.status);

                    if (skinsResponse.ok) {
                        currentSkins = await skinsResponse.json();
                        console.log("Skins primite:", currentSkins);
                    } else {
                        const errorText = await skinsResponse.text();
                        console.error("Eroare la obÈ›inerea skin-urilor:", errorText);
                    }

                    displaySkinsUI();
                } else {
                    const errorText = await userResponse.text();
                    console.error("Eroare la obÈ›inerea userului:", errorText);
                    alert("Eroare la Ã®ncÄƒrcarea datelor utilizatorului: " + errorText);
                }
            } catch (error) {
                console.error("Eroare:", error);
                alert("Eroare de conexiune la server: " + error.message);
            }
        };

        function displaySkinsUI() {
            const content = document.getElementById("skins-content");
            content.innerHTML = "";

            for (let shipType = 1; shipType <= 4; shipType++) {
                const section = document.createElement("div");
                section.className = "ship-type-section";

                const title = document.createElement("h3");
                title.innerText = shipTypeNames[shipType];
                section.appendChild(title);

                const optionsContainer = document.createElement("div");
                optionsContainer.className = "skin-options";

                availableSkins[shipType].forEach(skin => {
                    const option = document.createElement("div");
                    option.className = "skin-option";
                    if (currentSkins[shipType] === skin.path) {
                        option.classList.add("selected");
                    }

                    const preview = document.createElement("div");
                    preview.className = "skin-preview";
                    // afisam imaginea reala
                    preview.innerHTML = `<img src="${skin.path}" alt="${skin.name}" />`;

                    const name = document.createElement("p");
                    name.innerText = skin.name;
                    name.style.margin = "8px 0 0 0";
                    name.style.color = "white";

                    option.appendChild(preview);
                    option.appendChild(name);

                    option.onclick = () => selectSkin(shipType, skin.path, option);

                    optionsContainer.appendChild(option);
                });

                section.appendChild(optionsContainer);
                content.appendChild(section);
            }
        }

        function selectSkin(shipType, skinPath, element) {
            // DeselecteazÄƒ toate din acelaÈ™i grup
            element.parentElement.querySelectorAll(".skin-option").forEach(opt => {
                opt.classList.remove("selected");
            });

            // SelecteazÄƒ noul skin
            element.classList.add("selected");
            currentSkins[shipType] = skinPath;
        }

        async function saveSkins() {
            const statusEl = document.getElementById('save-status');
            if (statusEl) {
                statusEl.style.color = '#bdc3c7';
                statusEl.innerText = 'Se salveazÄƒ...';
            }

            if (!userId) {
                if (statusEl) {
                    statusEl.style.color = '#e74c3c';
                    statusEl.innerText = 'Eroare: ID utilizator lipseÈ™te';
                }
                return;
            }

            // fallback: daca ceva nu e selectat, salvam default
            for (let shipType = 1; shipType <= 4; shipType++) {
                if (!currentSkins[shipType]) {
                    currentSkins[shipType] = "img/default.png";
                }
            }

            console.log("=== SALVARE SKIN-URI ===");
            console.log("User ID:", userId);
            console.log("Current Skins:", currentSkins);

            try {
                for (let shipType = 1; shipType <= 4; shipType++) {
                    const skinPath = currentSkins[shipType];

                    const response = await fetch(`${API_BASE_URL}/api/skins/${userId}/${shipType}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ skinPath: skinPath })
                    });

                    const resultText = await response.text();

                    if (!response.ok) {
                        throw new Error(`Eroare la salvarea tipului ${shipType} (HTTP ${response.status}): ${resultText}`);
                    }
                }

                if (statusEl) {
                    statusEl.style.color = '#2ecc71';
                    statusEl.innerText = 'âœ… Skin-urile au fost salvate cu succes!';
                }

                // rÄƒmÃ¢nem pe paginÄƒ, fÄƒrÄƒ alert È™i fÄƒrÄƒ redirect
                return;
            } catch (error) {
                console.error("Eroare la salvare:", error);
                if (statusEl) {
                    statusEl.style.color = '#e74c3c';
                    statusEl.innerText = 'âŒ Eroare la salvarea skin-urilor: ' + error.message;
                }
            }
        }
    </script>
</body>
</html>
